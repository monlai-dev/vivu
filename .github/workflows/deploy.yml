name: CI/CD Build and Deploy to EC2

on:
  push:
    branches:
      - main

env:
  IMAGE_NAME: monlaine123/vivu:latest

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: staging

    steps:
      - name: ğŸ§¾ Checkout repository
        uses: actions/checkout@v3

      - name: ğŸ³ Login to Docker Hub
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      - name: ğŸ—ï¸ Build Docker image
        run: docker build --platform=linux/amd64 -t $IMAGE_NAME .

      - name: ğŸš€ Push Docker image to Docker Hub
        run: docker push $IMAGE_NAME

  deploy-to-ec2:
    runs-on: ubuntu-latest
    needs: build-and-deploy  # Wait until build job is done
    environment: staging

    steps:
      - name: ğŸ” Set up SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: ğŸ›°ï¸ Deploy to EC2 via SSH
        shell: bash
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          REPO_URL: ${{ secrets.REPO_URL }}
          RDS_CONNECTION: ${{ secrets.RDS_CONNECTION }}
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
          PORT:             8080
        run: |
          ssh -o StrictHostKeyChecking=no "$EC2_HOST" <<EOF
          set -e
          
          echo "ğŸ³ Install & start Docker (AL2023)"
          sudo dnf -y install docker || true
          sudo systemctl enable --now docker
          sudo usermod -aG docker ec2-user || true
          
          echo "ğŸ§© Install Docker Compose v2 plugin (multi-path for safety)"
          COMPOSE_VERSION="v2.29.7"
          ARCH="$(uname -m)"   # runs on the EC2 host thanks to the quoted heredoc
          URL="https://github.com/docker/compose/releases/download/${COMPOSE_VERSION}/docker-compose-linux-${ARCH}"
      
          # Install to the standard plugin dirs Docker scans
          sudo mkdir -p /usr/libexec/docker/cli-plugins /usr/local/lib/docker/cli-plugins ~/.docker/cli-plugins
          sudo curl -sSL "$URL" -o /usr/libexec/docker/cli-plugins/docker-compose
          sudo chmod +x /usr/libexec/docker/cli-plugins/docker-compose
      
          # Also copy to /usr/local/lib path (some builds check this too)
          sudo cp -f /usr/libexec/docker/cli-plugins/docker-compose /usr/local/lib/docker/cli-plugins/docker-compose
      
          # Optional: legacy shim so 'docker-compose' works
          sudo ln -sf /usr/libexec/docker/cli-plugins/docker-compose /usr/local/bin/docker-compose
      
          echo "âœ… Verify Compose plugin discovery"
          sudo env DOCKER_CLI_PLUGIN_PATH=/usr/libexec/docker/cli-plugins:/usr/local/lib/docker/cli-plugins docker compose version || true
          /usr/local/bin/docker-compose version || true

          echo "ğŸ” Logging in to Docker Hub"
          echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin

          echo "ğŸ§¾ Writing .env file"
          cat > .env <<EOT
          ENV=$ENV
          REDIS_URL=$REDIS_URL
          RDS_CONNECTION=$RDS_CONNECTION
          
          EOT
          
          echo "ğŸ›  Installing jq if it's missing"
          if ! command -v jq &> /dev/null; then
          sudo yum install -y jq || sudo apt-get install -y jq
          fi
          
          # docker-compose.yml (no repo required)
          cat > docker-compose.yml <<YML
          services:
            app:
              image: ${IMAGE_NAME}
              container_name: vivu
              env_file: .env
              ports:
                - "${PORT}:${PORT}"
              restart: unless-stopped
          YML
          
          echo "ğŸš€ Starting services using Docker Compose"
          docker-compose pull
          docker-compose up -d --remove-orphans --build
          EOF